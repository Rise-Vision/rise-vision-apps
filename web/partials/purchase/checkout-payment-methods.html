<!-- Step 4 -->
<div class="purchase-sideways-panels">
  <div id="checkout-payment-methods">
    <h4 class="u_margin-md-bottom">Payment Method</h4>

    <form id="form.paymentMethodsForm" role="form" name="form.paymentMethodsForm" novalidate>
      <div class="flex-row mb-4" ng-show="!purchase.plan.isMonthly">
        <div id="payment-method-select" class="btn-group btn-group-justified" ng-click="paymentMethods.paymentMethod = (paymentMethods.paymentMethod === 'card' ? 'invoice' : 'card')">
          <button type="button" class="btn"
            ng-class="{'btn-toggle-blue-off' : paymentMethods.paymentMethod !== 'card', 'btn-toggle-blue-on' : paymentMethods.paymentMethod === 'card'}">
            Pay With Credit Card
            <streamline-icon name="checkmark" ng-show="paymentMethods.paymentMethod === 'card'"></streamline-icon>
          </button>
          <button type="button" class="btn"
            ng-class="{'btn-toggle-blue-off' : paymentMethods.paymentMethod !== 'invoice', 'btn-toggle-blue-on' : paymentMethods.paymentMethod === 'invoice'}">
            Invoice Me
            <streamline-icon name="checkmark" ng-show="paymentMethods.paymentMethod === 'invoice'"></streamline-icon>
          </button>
        </div>
      </div>

      <div id="credit-card-form" ng-show="paymentMethods.paymentMethod === 'card'">
        <!-- Alpha Release - Select New Card by default -->
        <div class="row" ng-if="false">
          <div class="col-md-12">
            <div class="form-group">
              <label for="credit-card-select" class="hidden">Add New Credit Card</label>
              <select id="credit-card-select" class="form-control selectpicker" ng-model="paymentMethods.selectedCard" ng-options="c as getCardDescription(c) for c in paymentMethods.existingCreditCards track by c.id">
                <option value="">Add New Credit Card</option>
              </select>
            </div>
          </div>
        </div>

        <!-- NEW CREDIT CARD -->
        <div id="new-credit-card-form" ng-show="paymentMethods.selectedCard.isNew">
          <div class="row">
            <div class="col-md-12">
              <div class="form-group" ng-class="{ 'has-error': (form.paymentMethodsForm.cardholderName.$dirty || form.paymentMethodsForm.$submitted) && form.paymentMethodsForm.cardholderName.$invalid }">
                <label for="new-card-name" class="control-label">Cardholder Name: *</label>
                <input id="new-card-name" aria-required="true" type="text" class="form-control" name="cardholderName" data-stripe="name" ng-model="paymentMethods.newCreditCard.name" autocomplete="cc-name" required>
                <p class="text-danger" ng-show="(form.paymentMethodsForm.cardholderName.$dirty || form.paymentMethodsForm.$submitted) && form.paymentMethodsForm.cardholderName.$invalid">
                  Choose a Cardholder Name.
                </p>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12">
              <div class="form-group" ng-class="{ 'has-error': stripeElementError('new-card-number') }">
                <label for="new-card-number" class="control-label">Card Number: *</label>
                <div class="form-control" id="new-card-number"></div>
                <p class="text-danger" ng-show="stripeElementError('new-card-number')">
                  Choose a Card Number.
                </p>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-4">
              <div class="form-group" ng-class="{ 'has-error': stripeElementError('new-card-expiry') }">
                <label for="new-card-expiry" class="control-label">Expiration Date: *</label>
                <div class="form-control" id="new-card-expiry"></div>
                <p class="text-danger" ng-show="stripeElementError('new-card-expiry')">
                  Choose an Expiration Date Month and Year.
                </p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group" ng-class="{ 'has-error': stripeElementError('new-card-cvc') }">
                <label for="new-card-cvc" class="control-label">Security Code: *</label>
                <div class="form-control" id="new-card-cvc"></div>
                <p class="text-danger" ng-show="stripeElementError('new-card-cvc')">
                  Choose a Security Code.
                </p>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-12">
              <div class="form-group">
                <label for="toggleMatchBillingAddress" class="control-label mb-0">Cardholder Billing Address: *</label>
                <div class="flex-row">
                  <madero-checkbox id="toggleMatchBillingAddress" ng-model="paymentMethods.newCreditCard.useBillingAddress"></madero-checkbox>
                  <span class="mr-3">Use Company Billing Address</span>
                </div>
              </div>
            </div>
          </div>

          <!-- NEW CC ADDRESS -->
          <div id="new-card-address">

            <address-form form-object="form.paymentMethodsForm" address-object="paymentMethods.newCreditCard.address" hide-company-name="true" ng-if="!paymentMethods.newCreditCard.useBillingAddress"></address-form>

          </div>
          <!--  END NEW CC ADDRESS -->
        </div>
        <!-- END NEW CC -->

        <!-- EXISTING CREDIT CARD -->
        <div id="existing-credit-card-form" ng-if="!paymentMethods.selectedCard.isNew">
          <div id="errorBox" class="alert alert-danger" role="alert" ng-show="paymentMethods.selectedCard.validationErrors.length">
            <strong>Card Validation Error</strong> {{paymentMethods.selectedCard.validationErrors[0]}}
          </div>

          <div class="row">
            <div class="col-md-12">
              <div class="form-group">
                <label for="existing-card-name" class="control-label">Cardholder Name</label>
                <input id="existing-card-name" type="text" class="form-control" placeholder="{{paymentMethods.selectedCard.name}}" disabled="disabled">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12">
              <div class="form-group">
                <label for="existing-card-number" class="control-label">Card Number</label>
                <input id="existing-card-number" type="text" class="form-control" placeholder="{{paymentMethods.selectedCard.last4 | cardLastFour}}" disabled="disabled" />
              </div>
            </div>
          </div>
          <div class="row form-group">
            <div class="col-md-4">
              <div class="form-group">
                <label for="existing-card-expiry-month" class="control-label">Expiry Month</label>
                <input id="existing-card-expiry-month" type="text" class="form-control masked"  placeholder="{{paymentMethods.selectedCard.expMonth | paddedMonth}}" disabled="disabled" />
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label for="existing-card-expiry-year" class="control-label">Expiry Year</label>
                <input id="existing-card-expiry-year" type="text" class="form-control masked"  placeholder="{{paymentMethods.selectedCard.expYear}}" disabled="disabled"/>
              </div>
            </div>          
          </div>
        </div>
        <!-- END EXISTING CC -->
      </div>

      <!-- //GENERATE INVOICE FORM -->
      <div id="generateInvoice" ng-show="paymentMethods.paymentMethod === 'invoice'">
        <p>Please enter a purchase order number if applicable. Your invoice will be sent to 
          <b>{{contactEmail}}</b> with net 30 day terms. Invoice is payable by check, wire transfer, or credit card.</p>

        <div class="row">
          <div class="col-xs-12">
            <div class="form-group">
              <label for="invoice-po-number" class="control-label">
                Purchase Order Number (optional):
              </label>
              <input id="invoice-po-number" type="text" class="form-control" name="purchaseOrder" ng-model="paymentMethods.purchaseOrderNumber" />
            </div>
          </div>
        </div>

        <div id="generateInvoiceOverdue" class="hidden">
          <p class="text-danger">You have overdue invoice payments on your account.</p>
          <p>In order to complete this purchase by invoice, please pay your outstanding invoices <a href="#">here</a>.</p>
        </div>
      </div>

      <div id="errorBox" class="madero-style alert alert-danger u_margin-md-top" role="alert" ng-show="paymentMethods.newCreditCard.validationErrors.length">
        <strong>Card Validation Error<span ng-show="paymentMethods.newCreditCard.validationErrors.length > 1">s</span></strong>
        <ul>
          <li ng-repeat="error in paymentMethods.newCreditCard.validationErrors">{{error}}</li>
        </ul>
      </div>

    </form>

  </div>
  <purchase-summary></purchase-summary>
</div>

<div id="errorBox" class="madero-style alert alert-danger u_margin-md-top" role="alert" ng-show="paymentMethods.tokenError">
  <strong>Card Processing Error</strong> {{paymentMethods.tokenError}}
</div>

<div id="errorBox" class="madero-style alert alert-danger u_margin-md-top" role="alert" ng-show="purchase.checkoutError">
  <strong>Payment Error</strong> {{purchase.checkoutError}}
</div>

<div class="button-row text-right mt-5">
  <button id="backButton" type="button" aria-label="Go back to Billing Address" class="btn btn-default btn-toolbar pull-left" ng-click="setPreviousStep()" translate>common.back</button>
  <button id="payButton" type="submit" class="btn btn-primary btn-toolbar-wide" form="form.paymentMethodsForm" ng-click="completeCardPayment(cardNumber)" tabindex="1" aria-label="Complete Payment" ng-if="purchase.paymentMethods.paymentMethod === 'card'">
    <span id="payLabel">Pay ${{purchase.estimate.total | number:2}} Now</span>
  </button>
  <button id="invoiceButton" type="submit" class="btn btn-primary btn-toolbar-wide" form="form.paymentMethodsForm" ng-click="completePayment()" tabindex="1" aria-label="Complete Payment" ng-if="purchase.paymentMethods.paymentMethod === 'invoice'">
    <span id="invoiceLabel">Invoice Me ${{purchase.estimate.total | number:2}} Now</span>
  </button>
</div>
